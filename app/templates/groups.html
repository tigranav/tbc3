{% extends "base.html" %}
{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <p class="text-uppercase text-muted fw-semibold mb-2">Справочник PostgreSQL</p>
      <h1 class="fw-bold mb-2">Группы файлов книг</h1>
      <p class="text-muted mb-0">
        CRUD-интерфейс для таблицы <code>tbc.books_files_groups</code>. Все действия
        выполняются через существующий REST API <code>/api/groups</code>.
      </p>
    </div>
    <div class="text-end">
      <span class="badge bg-dark text-uppercase">В работе</span>
      <div class="small text-muted">Подключение к PostgreSQL / SQLAlchemy</div>
    </div>
  </div>

  <div id="alert-box" class="mb-3" aria-live="polite"></div>

  <div class="row g-4">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h5 mb-0">Список групп</h2>
            <small class="text-muted">Получено через GET /api/groups/</small>
          </div>
          <button class="btn btn-outline-secondary btn-sm" type="button" id="refresh-btn">
            <i class="bi bi-arrow-clockwise"></i> Обновить
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Название</th>
                  <th scope="col">Комментарий</th>
                  <th scope="col" class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody id="groups-table-body">
                <tr>
                  <td colspan="4" class="text-center py-4 text-muted">Загрузка...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h5 mb-0" id="form-title">Новая запись</h2>
            <small class="text-muted">POST /api/groups/</small>
          </div>
          <button class="btn btn-link text-decoration-none" type="button" id="reset-btn">
            Сбросить
          </button>
        </div>
        <div class="card-body">
          <form id="group-form" class="needs-validation" novalidate>
            <div class="mb-3">
              <label class="form-label" for="group-id">ID</label>
              <input type="number" class="form-control" id="group-id" required min="1" />
              <div class="form-text">Первичный ключ в таблице.</div>
              <div class="invalid-feedback">Укажите числовой идентификатор.</div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="group-name">Название</label>
              <input type="text" class="form-control" id="group-name" maxlength="50" />
              <div class="form-text">До 50 символов.</div>
            </div>
            <div class="mb-4">
              <label class="form-label" for="group-comment">Комментарий</label>
              <textarea class="form-control" id="group-comment" rows="2" maxlength="200"></textarea>
              <div class="form-text">Дополнительное описание (до 200 символов).</div>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-dark" type="submit" id="submit-btn">
                <i class="bi bi-plus-lg"></i> Создать
              </button>
              <small class="text-muted" id="form-hint">Форма создаёт новую запись.</small>
            </div>
          </form>
        </div>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h3 class="h6 text-uppercase text-muted mb-3">Памятка по очередям</h3>
          <p class="mb-2">
            CRUD операции выполняются синхронно, но могут быть встроены в Celery-задачи при
            необходимости фоновой обработки.
          </p>
          <p class="mb-0 text-muted small">
            Пример: валидировать данные и отправить задачу в очередь <code>cpu</code> или
            <code>gpu</code>, а затем обновить запись по результату.
          </p>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const alertBox = document.getElementById("alert-box");
    const tableBody = document.getElementById("groups-table-body");
    const refreshBtn = document.getElementById("refresh-btn");
    const resetBtn = document.getElementById("reset-btn");
    const form = document.getElementById("group-form");
    const formTitle = document.getElementById("form-title");
    const submitBtn = document.getElementById("submit-btn");
    const formHint = document.getElementById("form-hint");
    const fieldId = document.getElementById("group-id");
    const fieldName = document.getElementById("group-name");
    const fieldComment = document.getElementById("group-comment");

    let groupsCache = [];
    let editingId = null;

    const clearAlert = () => {
      alertBox.innerHTML = "";
    };

    const showAlert = (message, type = "success") => {
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
    };

    const setFormMode = (groupId = null) => {
      editingId = groupId;
      if (groupId === null) {
        formTitle.textContent = "Новая запись";
        submitBtn.innerHTML = '<i class="bi bi-plus-lg"></i> Создать';
        formHint.textContent = "Форма создаёт новую запись.";
        fieldId.removeAttribute("readonly");
        form.reset();
      } else {
        formTitle.textContent = `Редактирование #${groupId}`;
        submitBtn.innerHTML = '<i class="bi bi-save"></i> Сохранить изменения';
        formHint.textContent = "PUT /api/groups/<id>";
        fieldId.setAttribute("readonly", "readonly");
      }
    };

    const renderRows = (items) => {
      tableBody.innerHTML = "";
      if (!items.length) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Нет данных</td></tr>';
        return;
      }
      items.forEach((item) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <th scope="row" class="fw-semibold">${item.id}</th>
          <td>${item.name ?? "—"}</td>
          <td class="text-muted">${item.comment ?? ""}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary" data-action="edit" data-id="${item.id}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" data-action="delete" data-id="${item.id}">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>`;
        tableBody.appendChild(row);
      });
    };

    const loadGroups = async () => {
      clearAlert();
      tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">Загрузка...</td></tr>';
      try {
        const response = await fetch("/api/groups/");
        if (!response.ok) {
          throw new Error(`Ошибка ${response.status}`);
        }
        const data = await response.json();
        groupsCache = data.items || [];
        renderRows(groupsCache);
      } catch (error) {
        renderRows([]);
        showAlert(`Не удалось получить данные: ${error.message}`, "danger");
      }
    };

    const findGroup = (id) => groupsCache.find((group) => group.id === id);

    tableBody.addEventListener("click", async (event) => {
      const target = event.target.closest("button[data-action]");
      if (!target) return;
      const action = target.dataset.action;
      const groupId = Number(target.dataset.id);
      const current = findGroup(groupId);
      if (!current) return;

      if (action === "edit") {
        fieldId.value = current.id;
        fieldName.value = current.name ?? "";
        fieldComment.value = current.comment ?? "";
        setFormMode(current.id);
        form.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      if (action === "delete") {
        const confirmDelete = confirm(`Удалить группу #${groupId}?`);
        if (!confirmDelete) return;
        try {
          const response = await fetch(`/api/groups/${groupId}`, { method: "DELETE" });
          if (!response.ok) {
            throw new Error(`Статус ${response.status}`);
          }
          showAlert(`Группа #${groupId} удалена.`);
          await loadGroups();
          setFormMode(null);
        } catch (error) {
          showAlert(`Не удалось удалить: ${error.message}`, "danger");
        }
      }
    });

    refreshBtn.addEventListener("click", (event) => {
      event.preventDefault();
      loadGroups();
    });

    resetBtn.addEventListener("click", (event) => {
      event.preventDefault();
      setFormMode(null);
      clearAlert();
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      event.stopPropagation();

      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        return;
      }

      const payload = {
        id: Number(fieldId.value),
        name: fieldName.value || null,
        comment: fieldComment.value || null,
      };

      const isEdit = editingId !== null;
      const url = isEdit ? `/api/groups/${editingId}` : "/api/groups/";
      const method = isEdit ? "PUT" : "POST";

      try {
        const response = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const message = errorData.message || `Статус ${response.status}`;
          throw new Error(message);
        }
        const data = await response.json();
        const actionLabel = isEdit ? "обновлена" : "создана";
        showAlert(`Группа #${data.group?.id ?? payload.id} ${actionLabel}.`);
        await loadGroups();
        setFormMode(null);
      } catch (error) {
        showAlert(`Ошибка сохранения: ${error.message}`, "danger");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      setFormMode(null);
      loadGroups();
    });
  </script>
{% endblock %}
